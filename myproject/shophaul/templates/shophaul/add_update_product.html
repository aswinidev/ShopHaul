{% extends 'base.html' %}
{% load static %}

{% block title %}ShopHaul | Add-Update Products{% endblock %}

{% block content %}
<div class="container pb-3">
    <h2>Add/Update Products</h2>
    <div class="col-sm-4 text-right"><button class="btn btn-primary" onclick="$('#newItem').modal();">Add
                Product</button>
    </div>
    {% if items %}
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Address</th>
                <th>Seller</th>
                <th>Update</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr id="{{ item.name }}">
                <td> {{ item.name }} </td>
                <td id="{{ item.name }} quantity"> {{ item.quantity }} </td>
                <td id="{{ item.name }} price"> {{ item.price }} </td>
                <td id="{{ item.name }} address">{{ item.address }} </td>
                <td> <button id="{{forloop.counter  }}" type="button" class="btn btn-info"
                        onClick="showModal(this.id)">Update</button> </td>
                <td> <button type="button" class="btn btn-danger" onClick="deleteItem('{{item.name}}')">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>{{ message }}</p>
    {% endif %}
</div>
<div id="updateModal" class="modal" role="dialog"></div>
<div id="newItem" class="modal" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Product</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        &times;
                    </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="newName">Product's Name</label>
                        <input type="text" id="newName" class="form-control" placeholder="Name">
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="newQuantity">Quantity</label>
                            <input type="number" id="newQuantity" min="0" class="form-control" placeholder="Quantity" value="0">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="newPrice">Price (INR)</label>
                            <input type="number" id="newPrice" min="0" class="form-control" placeholder="Price"
                                value="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="newAddress">Address</label>
                            <input type="text" id="newAddress" class="form-control" placeholder="Address">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onClick="newItem();" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="confirm" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Warning</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <span id="title"></span>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id='btn-delete' onclick="handleConf()">Yes</button>
                <button type="button" class="btn btn-success" data-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>
<script>
    {% if itm %}
    let items = {{ itm | safe }};
    {% endif %}
    
    function showModal(id) {
        id = Number(id) - 1;
        document.getElementById('updateModal').innerHTML = `
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Update Product Details</h5>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="form-group">
                                <label for="Name">Product's Name</label>
                                <input type="text" id="name" class="form-control" disabled value="${items[id][0]}">
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="Quantity">Quantity</label>
                                    <input type="number" id="quantity" min="0" class="form-control" placeholder="Quantity" value="${items[id][1]}">
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="Price">Price</label>
                                    <input type="number" id="price" min="0" class="form-control" placeholder="Price" value="${items[id][2]}">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="address">Address</label>
                                    <input type="text" id="address" class="form-control" placeholder="Address" value="${items[id][3]}">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">                        
                        <button type="button" onClick="submitForm();" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        `;
        $('#updateModal').modal()
    }

    function submitForm() {
        var req_data = {
            name: `${document.getElementById('name').value}`,
            quantity: Number(document.getElementById('quantity').value),
            price: Number(document.getElementById('price').value),
            address: `${document.getElementById('address').value}`,
        }

        $.ajax({
            url: "{% url 'Add/Update Product' %}",
            method: "POST",
            data: req_data,
            success: function (data, status, xhr) {
                if (data['status'] == "Success") {
                    iziToast.success({
                        title: 'OK',
                        message: 'Successfully Updated the item!',
                    })
                    return setTimeout(() => window.location.reload(), 1000);
                }
                iziToast.error({
                    title: 'Error',
                    message: `${data['status']}`,
                });
            },
            error: function (xhr, status, err) {
                iziToast.error({
                    title: 'Error',
                    message: `${err}`,
                });
            }
        });
    }

    function newItem() {
        if (document.getElementById('newName').value === "") return iziToast.warning({
            title: 'Caution',
            message: 'Name cannot be Left Empty',
        });
        else if (document.getElementById('newQuantity').value === "") return iziToast.warning({
            title: 'Caution',
            message: 'Quantity cannot be Left Empty',
        });
        else if (document.getElementById('newPrice').value === "") return iziToast.warning({
            title: 'Caution',
            message: 'Price cannot be Left Empty',
        });
        else if (document.getElementById('newAddress').value === "") return iziToast.warning({
            title: 'Caution',
            message: 'Address cannot be Left Empty',
        });
        var req_data = {
            name: `${document.getElementById('newName').value}`,
            quantity: Number(document.getElementById('newQuantity').value),
            price: Number(document.getElementById('newPrice').value),
            address: `${(document.getElementById('newAddress').value)}`,
        };
        $.ajax({
            url: "{% url 'Add Product' %}",
            method: "POST",
            data: req_data,
            success: function (data, status, xhr) {
                if (data['status'] == "Success") {
                    iziToast.success({
                        title: 'OK',
                        message: 'Successfully Added New Item!',
                    })
                    return setTimeout(() => window.location.reload(), 1000);
                }
                iziToast.error({
                    title: 'Error',
                    message: `${data['status']}`,
                });
            },
            error: function (xhr, status, err) {
                iziToast.error({
                    title: 'Error',
                    message: `${err}`,
                });
            }
        });
    }

    const handleConf = (name) => {
        $.ajax({
            url: "{% url 'Delete Product' %}",
            method: "POST",
            data: { name: name },
            success: function (data, status, xhr) {
                if (data['status'] == "Success") {
                    return window.location.reload();
                }
                iziToast.error({
                    title: 'Error',
                    message: `${data['status']}`,
                });
                console.log(data);

            },
            error: function (xhr, status, err) {
                iziToast.error({
                    title: 'Error',
                    message: `${err}`,
                });
            }
        });
    };
    function deleteItem(name) {
        document.getElementById('title').innerText = name;
        document.getElementById('btn-delete').onclick = () => handleConf(name);
        $('#confirm').modal();
    }
</script>
{% endblock content %}

